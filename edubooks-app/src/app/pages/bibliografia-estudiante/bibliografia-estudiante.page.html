<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title>Bibliografías de Curso</ion-title>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/home"></ion-back-button>
    </ion-buttons>
    <ion-buttons slot="end">
      <ion-button (click)="toggleFiltros()">
        <ion-icon name="filter" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-header collapse="condense">
    <ion-toolbar>
      <ion-title size="large">Bibliografías</ion-title>
    </ion-toolbar>
  </ion-header>

  <!-- Refresher -->
  <ion-refresher slot="fixed" (ionRefresh)="doRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <!-- Información del programa del estudiante -->
  <ion-card *ngIf="esEstudiante && programaEstudiante" color="primary">
    <ion-card-content>
      <div style="display: flex; align-items: center; gap: 10px;">
        <ion-icon name="school" size="large"></ion-icon>
        <div>
          <h3 style="margin: 0; color: white;">{{ programaEstudiante }}</h3>
          <p style="margin: 0; color: white; opacity: 0.8;">Bibliografías de tu programa académico</p>
        </div>
      </div>
    </ion-card-content>
  </ion-card>

  <!-- Filtros -->
  <ion-card *ngIf="mostrarFiltros">
    <ion-card-header>
      <ion-card-title>Filtros de Búsqueda</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-item>
        <ion-select 
          [(ngModel)]="filtroPrograma" 
          placeholder="Seleccionar programa"
          (ionChange)="aplicarFiltros()">
          <ion-select-option value="">Todos los programas</ion-select-option>
          <ion-select-option *ngFor="let programa of programas" [value]="programa">
            {{ programa }}
          </ion-select-option>
        </ion-select>
        <ion-label slot="start">Programa:</ion-label>
      </ion-item>
      
      <ion-item>
        <ion-input 
          [(ngModel)]="filtroCurso" 
          placeholder="Buscar por curso"
          (ionInput)="aplicarFiltros()">
        </ion-input>
        <ion-label slot="start">Curso:</ion-label>
      </ion-item>
      
      <ion-button fill="clear" (click)="limpiarFiltros()">
        <ion-icon name="refresh" slot="start"></ion-icon>
        Limpiar filtros
      </ion-button>
    </ion-card-content>
  </ion-card>

  <!-- Loading -->
  <div *ngIf="isLoading" class="loading-container">
    <ion-spinner name="crescent"></ion-spinner>
    <p>Cargando bibliografías...</p>
  </div>

  <!-- Error -->
  <ion-card *ngIf="error && !isLoading" color="danger">
    <ion-card-content>
      <ion-icon name="alert-circle" class="error-icon"></ion-icon>
      <p>{{ error }}</p>
      <ion-button fill="clear" (click)="cargarBibliografias()">
        <ion-icon name="refresh" slot="start"></ion-icon>
        Reintentar
      </ion-button>
    </ion-card-content>
  </ion-card>

  <!-- Sin bibliografías -->
  <div *ngIf="!isLoading && !error && bibliografiasFiltradas.length === 0" class="empty-state">
    <ion-icon name="library-outline" class="empty-icon"></ion-icon>
    <h3>No hay bibliografías disponibles</h3>
    <p *ngIf="esEstudiante">No se encontraron bibliografías para tu programa académico.</p>
    <p *ngIf="!esEstudiante">No hay bibliografías que coincidan con los filtros aplicados.</p>
  </div>

  <!-- Lista de bibliografías -->
  <div *ngIf="!isLoading && !error && bibliografiasFiltradas.length > 0">
    <ion-card *ngFor="let bibliografia of bibliografiasFiltradas" class="bibliografia-card">
      <ion-card-header>
        <ion-card-title>{{ bibliografia.curso }}</ion-card-title>
        <ion-card-subtitle>
          <ion-chip color="secondary" size="small">
            <ion-icon name="school" slot="start"></ion-icon>
            <ion-label>{{ bibliografia.programa }}</ion-label>
          </ion-chip>
          <span *ngIf="bibliografia.descripcion">{{ bibliografia.descripcion }}</span>
        </ion-card-subtitle>
      </ion-card-header>

      <ion-card-content>
        <!-- Información del docente -->
        <div class="docente-info">
          <ion-chip color="tertiary">
            <ion-icon name="person" slot="start"></ion-icon>
            <ion-label>{{ bibliografia.docente.nombre }} {{ bibliografia.docente.apellido }}</ion-label>
          </ion-chip>
        </div>

        <!-- Información de la bibliografía -->
        <div class="bibliografia-info">
          <ion-chip color="primary">
            <ion-icon name="book" slot="start"></ion-icon>
            <ion-label>{{ bibliografia.libros?.length || bibliografia.total_libros || 0 }} libros</ion-label>
          </ion-chip>
          
          <ion-chip color="success">
            <ion-icon name="globe" slot="start"></ion-icon>
            <ion-label>Pública</ion-label>
          </ion-chip>
        </div>

        <!-- Lista de libros -->
        <div *ngIf="bibliografia.libros && bibliografia.libros.length > 0" class="libros-lista">
          <h4>Libros recomendados:</h4>
          <ion-item *ngFor="let libro of bibliografia.libros" 
                   lines="none" 
                   class="libro-item"
                   button
                   (click)="verDetalleLibro(libro)">
            <ion-avatar slot="start">
              <img [src]="libro.imagen_portada || 'assets/images/book-placeholder.png'" 
                   [alt]="libro.titulo">
            </ion-avatar>
            <ion-label>
              <h3>{{ libro.titulo }}</h3>
              <p>{{ libro.autor }}</p>
              <p class="libro-categoria">{{ libro.categoria }}</p>
              <ion-chip 
                [color]="libro.estado === 'Disponible' ? 'success' : 'warning'" 
                size="small">
                <ion-label>{{ libro.estado }}</ion-label>
              </ion-chip>
            </ion-label>
            <ion-icon name="chevron-forward" slot="end"></ion-icon>
          </ion-item>
        </div>

        <!-- Sin libros -->
        <div *ngIf="!bibliografia.libros || bibliografia.libros.length === 0" class="sin-libros">
          <ion-icon name="book-outline" class="sin-libros-icon"></ion-icon>
          <p>No hay libros en esta bibliografía</p>
        </div>
      </ion-card-content>
    </ion-card>
  </div>
</ion-content>
