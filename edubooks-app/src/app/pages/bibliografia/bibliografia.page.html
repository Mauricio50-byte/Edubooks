<!-- src/app/pages/bibliografia/bibliografia.page.html -->
<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title>Gestión de Bibliografías</ion-title>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/home"></ion-back-button>
    </ion-buttons>
    <ion-buttons slot="end" *ngIf="esDocente">
      <ion-button (click)="crearBibliografia()">
        <ion-icon name="add" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-header collapse="condense">
    <ion-toolbar>
      <ion-title size="large">Bibliografías</ion-title>
    </ion-toolbar>
  </ion-header>

  <!-- Refresher -->
  <ion-refresher slot="fixed" (ionRefresh)="doRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <!-- Barra de búsqueda y filtros -->
  <ion-card *ngIf="!isLoading">
    <ion-card-content>
      <ion-searchbar 
        [(ngModel)]="terminoBusqueda"
        placeholder="Buscar por curso o programa"
        (ionInput)="buscarBibliografias($event)"
        show-clear-button="focus">
      </ion-searchbar>
      
      <div class="filtros-container">
        <ion-item>
          <ion-select 
            [(ngModel)]="filtroPrograma" 
            placeholder="Filtrar por programa"
            (ionChange)="aplicarFiltros()">
            <ion-select-option value="">Todos los programas</ion-select-option>
            <ion-select-option *ngFor="let programa of programasDisponibles" [value]="programa">
              {{ programa }}
            </ion-select-option>
          </ion-select>
          <ion-label slot="start">Programa:</ion-label>
        </ion-item>
        
        <ion-item>
          <ion-select 
            [(ngModel)]="filtroEstado" 
            placeholder="Filtrar por estado"
            (ionChange)="aplicarFiltros()">
            <ion-select-option value="">Todos los estados</ion-select-option>
            <ion-select-option value="true">Activas</ion-select-option>
            <ion-select-option value="false">Inactivas</ion-select-option>
          </ion-select>
          <ion-label slot="start">Estado:</ion-label>
        </ion-item>
        
        <ion-button fill="clear" (click)="limpiarFiltros()" *ngIf="hayFiltrosActivos()">
          <ion-icon name="refresh" slot="start"></ion-icon>
          Limpiar filtros
        </ion-button>
      </div>
    </ion-card-content>
  </ion-card>

  <!-- Loading -->
  <div *ngIf="isLoading" class="loading-container">
    <ion-spinner name="crescent"></ion-spinner>
    <p>Cargando bibliografías...</p>
  </div>

  <!-- Error -->
  <ion-card *ngIf="error && !isLoading" color="danger">
    <ion-card-content>
      <ion-icon name="alert-circle" class="error-icon"></ion-icon>
      <p>{{ error }}</p>
      <ion-button fill="clear" (click)="cargarBibliografias()">
        <ion-icon name="refresh" slot="start"></ion-icon>
        Reintentar
      </ion-button>
    </ion-card-content>
  </ion-card>

  <!-- Sin bibliografías -->
  <div *ngIf="!isLoading && !error && bibliografiasFiltradas.length === 0" class="empty-state">
    <ion-icon name="library-outline" class="empty-icon"></ion-icon>
    <h3 *ngIf="bibliografias.length === 0">No hay bibliografías</h3>
    <h3 *ngIf="bibliografias.length > 0">No se encontraron resultados</h3>
    <p *ngIf="esDocente && bibliografias.length === 0">Crea tu primera bibliografía para organizar los libros de tus cursos.</p>
    <p *ngIf="!esDocente && bibliografias.length === 0">No tienes acceso para crear bibliografías. Solo los docentes pueden gestionar bibliografías.</p>
    <p *ngIf="bibliografias.length > 0">Intenta ajustar los filtros de búsqueda.</p>
    <ion-button *ngIf="esDocente && bibliografias.length === 0" (click)="crearBibliografia()" fill="outline">
      <ion-icon name="add" slot="start"></ion-icon>
      Crear Bibliografía
    </ion-button>
    <ion-button *ngIf="bibliografias.length > 0" (click)="limpiarFiltros()" fill="outline">
      <ion-icon name="refresh" slot="start"></ion-icon>
      Limpiar filtros
    </ion-button>
  </div>

  <!-- Lista de bibliografías -->
  <div *ngIf="!isLoading && !error && bibliografiasFiltradas.length > 0">
    <ion-card *ngFor="let bibliografia of bibliografiasFiltradas" class="bibliografia-card">
      <ion-card-header>
        <ion-card-title>{{ bibliografia.curso }}</ion-card-title>
        <ion-card-subtitle *ngIf="bibliografia.descripcion">
          {{ bibliografia.descripcion }}
        </ion-card-subtitle>
      </ion-card-header>

      <ion-card-content>
        <!-- Información de la bibliografía -->
        <div class="bibliografia-info">
          <ion-chip color="secondary">
            <ion-icon name="school" slot="start"></ion-icon>
            <ion-label>{{ bibliografia.programa }}</ion-label>
          </ion-chip>
          
          <ion-chip color="primary">
            <ion-icon name="book" slot="start"></ion-icon>
            <ion-label>{{ bibliografia.libros?.length || bibliografia.total_libros || 0 }} libros</ion-label>
          </ion-chip>
          
          <ion-chip [color]="bibliografia.es_publica ? 'success' : 'medium'">
            <ion-icon [name]="bibliografia.es_publica ? 'globe' : 'lock-closed'" slot="start"></ion-icon>
            <ion-label>{{ bibliografia.es_publica ? 'Pública' : 'Privada' }}</ion-label>
          </ion-chip>
          
          <ion-chip [color]="bibliografia.activa ? 'success' : 'danger'">
            <ion-icon [name]="bibliografia.activa ? 'checkmark-circle' : 'close-circle'" slot="start"></ion-icon>
            <ion-label>{{ bibliografia.activa ? 'Activa' : 'Inactiva' }}</ion-label>
          </ion-chip>
        </div>

        <!-- Lista de libros -->
        <div *ngIf="bibliografia.libros && bibliografia.libros.length > 0" class="libros-lista">
          <h4>Libros incluidos:</h4>
          <ion-item *ngFor="let libro of bibliografia.libros" lines="none" class="libro-item">
            <ion-avatar slot="start">
              <img [src]="libro.imagen_portada || 'assets/images/book-placeholder.png'" 
                   [alt]="libro.titulo">
            </ion-avatar>
            <ion-label>
              <h3>{{ libro.titulo }}</h3>
              <p>{{ libro.autor }}</p>
              <p class="libro-categoria">{{ libro.categoria }}</p>
            </ion-label>
            <ion-button *ngIf="esDocente" 
                       fill="clear" 
                       color="danger" 
                       slot="end"
                       (click)="removerLibro(bibliografia, libro)">
              <ion-icon name="trash" slot="icon-only"></ion-icon>
            </ion-button>
          </ion-item>
        </div>

        <!-- Sin libros -->
        <div *ngIf="!bibliografia.libros || bibliografia.libros.length === 0" class="sin-libros">
          <ion-icon name="book-outline" class="sin-libros-icon"></ion-icon>
          <p>No hay libros en esta bibliografía</p>
        </div>

        <!-- Acciones -->
        <div *ngIf="esDocente" class="acciones">
          <ion-button fill="outline" (click)="agregarLibro(bibliografia)">
            <ion-icon name="add" slot="start"></ion-icon>
            Agregar Libro
          </ion-button>
          
          <ion-button fill="clear" (click)="editarBibliografia(bibliografia)">
            <ion-icon name="create" slot="start"></ion-icon>
            Editar
          </ion-button>
        </div>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- FAB para crear bibliografía -->
  <ion-fab *ngIf="esDocente && !isLoading" vertical="bottom" horizontal="end" slot="fixed">
    <ion-fab-button (click)="crearBibliografia()">
      <ion-icon name="add"></ion-icon>
    </ion-fab-button>
  </ion-fab>
</ion-content>
